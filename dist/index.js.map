{"version":3,"sources":["../src/actions.ts","../src/wallet.ts","../src/index.ts"],"sourcesContent":["import { getOnChainTools } from \"@goat-sdk/adapter-vercel-ai\";\nimport { MODE, USDC, erc20 } from \"@goat-sdk/plugin-erc20\";\nimport { kim } from \"@goat-sdk/plugin-kim\";\nimport { sendETH } from \"@goat-sdk/wallet-evm\";\nimport { WalletClientBase } from \"@goat-sdk/core\";\nimport { getWalletClient } from \"./wallet\";\n\nimport {\n    generateText,\n    type HandlerCallback,\n    type IAgentRuntime,\n    type Memory,\n    ModelClass,\n    type State,\n    composeContext,\n} from \"@elizaos/core\";\n\nexport function getOnChainActions() {\n    const actionsWithoutHandler = [\n        {\n            name: \"SWAP_TOKENS\",\n            description: \"Swap two different tokens using KIM protocol\",\n            similes: [],\n            validate: async () => true,\n            examples: [],\n        },\n        // 1. Add your actions here\n    ];\n\n    // 3. Let GOAT handle all the actions\n    return actionsWithoutHandler.map((action) => ({\n        ...action,\n        handler: getActionHandler(action.name, action.description),\n    }));\n}\n\nfunction getActionHandler(\n    actionName: string,\n    actionDescription: string,\n) {\n    let wallet: WalletClientBase | null = null;\n    let toolsPromise: Promise<any> | null = null;\n    \n    return async (\n        runtime: IAgentRuntime,\n        message: Memory,\n        state: State | undefined,\n        options?: Record<string, unknown>,\n        callback?: HandlerCallback\n    ): Promise<boolean> => {\n        if (!wallet) {\n            wallet = getWalletClient(runtime);\n        }\n        if (!toolsPromise) {\n            toolsPromise = getOnChainTools({\n                wallet,\n                // 2. Configure the plugins you need to perform those actions\n                plugins: [sendETH(), erc20({ tokens: [USDC, MODE] }), kim()],\n            });\n        }\n        const tools = await toolsPromise;\n\n        let currentState = state ?? (await runtime.composeState(message));\n        currentState = await runtime.updateRecentMessageState(currentState);\n\n        try {\n            // 1. Call the tools needed\n            const context = composeActionContext(\n                actionName,\n                actionDescription,\n                currentState\n            );\n            const result = await generateText({\n                runtime,\n                context,\n                tools,\n                maxSteps: 10,\n                // Uncomment to see the log each tool call when debugging\n                // onStepFinish: (step) => {\n                //     console.log(step.toolResults);\n                // },\n                modelClass: ModelClass.LARGE,\n            });\n\n            // 2. Compose the response\n            const response = composeResponseContext(result, currentState);\n            const responseText = await generateResponse(runtime, response);\n\n            callback?.({\n                text: responseText,\n                content: {},\n            });\n            return true;\n        } catch (error) {\n            const errorMessage =\n                error instanceof Error ? error.message : String(error);\n\n            // 3. Compose the error response\n            const errorResponse = composeErrorResponseContext(\n                errorMessage,\n                currentState\n            );\n            const errorResponseText = await generateResponse(\n                runtime,\n                errorResponse\n            );\n\n            callback?.({\n                text: errorResponseText,\n                content: { error: errorMessage },\n            });\n            return false;\n        }\n    };\n}\n\nfunction composeActionContext(\n    actionName: string,\n    actionDescription: string,\n    state: State\n): string {\n    const actionTemplate = `\n# Knowledge\n{{knowledge}}\n\nAbout {{agentName}}:\n{{bio}}\n{{lore}}\n\n{{providers}}\n\n{{attachments}}\n\n\n# Action: ${actionName}\n${actionDescription}\n\n{{recentMessages}}\n\nBased on the action chosen and the previous messages, execute the action and respond to the user using the tools you were given.\n`;\n    return composeContext({ state, template: actionTemplate });\n}\n\nfunction composeResponseContext(result: unknown, state: State): string {\n    const responseTemplate = `\n    # Action Examples\n{{actionExamples}}\n(Action examples are for reference only. Do not use the information from them in your response.)\n\n# Knowledge\n{{knowledge}}\n\n# Task: Generate dialog and actions for the character {{agentName}}.\nAbout {{agentName}}:\n{{bio}}\n{{lore}}\n\n{{providers}}\n\n{{attachments}}\n\n# Capabilities\nNote that {{agentName}} is capable of reading/seeing/hearing various forms of media, including images, videos, audio, plaintext and PDFs. Recent attachments have been included above under the \"Attachments\" section.\n\nHere is the result:\n${JSON.stringify(result)}\n\n{{actions}}\n\nRespond to the message knowing that the action was successful and these were the previous messages:\n{{recentMessages}}\n  `;\n    return composeContext({ state, template: responseTemplate });\n}\n\nfunction composeErrorResponseContext(\n    errorMessage: string,\n    state: State\n): string {\n    const errorResponseTemplate = `\n# Knowledge\n{{knowledge}}\n\n# Task: Generate dialog and actions for the character {{agentName}}.\nAbout {{agentName}}:\n{{bio}}\n{{lore}}\n\n{{providers}}\n\n{{attachments}}\n\n# Capabilities\nNote that {{agentName}} is capable of reading/seeing/hearing various forms of media, including images, videos, audio, plaintext and PDFs. Recent attachments have been included above under the \"Attachments\" section.\n\n{{actions}}\n\nRespond to the message knowing that the action failed.\nThe error was:\n${errorMessage}\n\nThese were the previous messages:\n{{recentMessages}}\n    `;\n    return composeContext({ state, template: errorResponseTemplate });\n}\n\nasync function generateResponse(\n    runtime: IAgentRuntime,\n    context: string\n): Promise<string> {\n    return generateText({\n        runtime,\n        context,\n        modelClass: ModelClass.SMALL,\n    });\n}\n","import { IAgentRuntime } from \"@elizaos/core\";\nimport { WalletClientBase } from \"@goat-sdk/core\";\nimport { viem } from \"@goat-sdk/wallet-viem\";\nimport { createWalletClient, http } from \"viem\";\nimport { privateKeyToAccount } from \"viem/accounts\";\nimport { mode } from \"viem/chains\";\n\n// Add the chain you want to use, remember to update also\n// the EVM_PROVIDER_URL to the correct one for the chain\nexport const chain = mode;\n\nexport function getWalletClient(\n    runtime: IAgentRuntime\n) {\n    const privateKey = runtime.getSetting('EVM_PRIVATE_KEY');\n    if (!privateKey) return null;\n\n    const provider = runtime.getSetting('EVM_PROVIDER_URL');\n    if (!provider) throw new Error(\"EVM_PROVIDER_URL not configured\");\n\n    const wallet = createWalletClient({\n        account: privateKeyToAccount(privateKey as `0x${string}`),\n        chain: chain,\n        transport: http(provider),\n    });\n\n    return viem(wallet);\n}\n\nexport function getWalletProvider() {\n    let walletClient: WalletClientBase | null = null;\n    return {\n        async get(runtime: IAgentRuntime): Promise<string | null> {\n            if (!walletClient) {\n                walletClient = getWalletClient(runtime);\n            }\n\n            try {\n                const address = walletClient.getAddress();\n                const balance = await walletClient.balanceOf(address);\n                return `EVM Wallet Address: ${address}\\nBalance: ${balance} ETH`;\n            } catch (error) {\n                console.error(\"Error in EVM wallet provider:\", error);\n                return null;\n            }\n        },\n    };\n}\n","import { getOnChainActions } from \"./actions\";\nimport { getWalletProvider } from \"./wallet\";\n\nconst goatPlugin = {\n    name: \"[GOAT] Onchain Actions\",\n    description: \"Mode integration plugin\",\n    providers: [getWalletProvider()],\n    evaluators: [],\n    services: [],\n    actions: getOnChainActions(),\n};\nexport default goatPlugin;"],"mappings":";AAAA,SAAS,uBAAuB;AAChC,SAAS,MAAM,MAAM,aAAa;AAClC,SAAS,WAAW;AACpB,SAAS,eAAe;;;ACDxB,SAAS,YAAY;AACrB,SAAS,oBAAoB,YAAY;AACzC,SAAS,2BAA2B;AACpC,SAAS,YAAY;AAId,IAAM,QAAQ;AAEd,SAAS,gBACZ,SACF;AACE,QAAM,aAAa,QAAQ,WAAW,iBAAiB;AACvD,MAAI,CAAC,WAAY,QAAO;AAExB,QAAM,WAAW,QAAQ,WAAW,kBAAkB;AACtD,MAAI,CAAC,SAAU,OAAM,IAAI,MAAM,iCAAiC;AAEhE,QAAM,SAAS,mBAAmB;AAAA,IAC9B,SAAS,oBAAoB,UAA2B;AAAA,IACxD;AAAA,IACA,WAAW,KAAK,QAAQ;AAAA,EAC5B,CAAC;AAED,SAAO,KAAK,MAAM;AACtB;AAEO,SAAS,oBAAoB;AAChC,MAAI,eAAwC;AAC5C,SAAO;AAAA,IACH,MAAM,IAAI,SAAgD;AACtD,UAAI,CAAC,cAAc;AACf,uBAAe,gBAAgB,OAAO;AAAA,MAC1C;AAEA,UAAI;AACA,cAAM,UAAU,aAAa,WAAW;AACxC,cAAM,UAAU,MAAM,aAAa,UAAU,OAAO;AACpD,eAAO,uBAAuB,OAAO;AAAA,WAAc,OAAO;AAAA,MAC9D,SAAS,OAAO;AACZ,gBAAQ,MAAM,iCAAiC,KAAK;AACpD,eAAO;AAAA,MACX;AAAA,IACJ;AAAA,EACJ;AACJ;;;ADxCA;AAAA,EACI;AAAA,EAIA;AAAA,EAEA;AAAA,OACG;AAEA,SAAS,oBAAoB;AAChC,QAAM,wBAAwB;AAAA,IAC1B;AAAA,MACI,MAAM;AAAA,MACN,aAAa;AAAA,MACb,SAAS,CAAC;AAAA,MACV,UAAU,YAAY;AAAA,MACtB,UAAU,CAAC;AAAA,IACf;AAAA;AAAA,EAEJ;AAGA,SAAO,sBAAsB,IAAI,CAAC,YAAY;AAAA,IAC1C,GAAG;AAAA,IACH,SAAS,iBAAiB,OAAO,MAAM,OAAO,WAAW;AAAA,EAC7D,EAAE;AACN;AAEA,SAAS,iBACL,YACA,mBACF;AACE,MAAI,SAAkC;AACtC,MAAI,eAAoC;AAExC,SAAO,OACH,SACA,SACA,OACA,SACA,aACmB;AACnB,QAAI,CAAC,QAAQ;AACT,eAAS,gBAAgB,OAAO;AAAA,IACpC;AACA,QAAI,CAAC,cAAc;AACf,qBAAe,gBAAgB;AAAA,QAC3B;AAAA;AAAA,QAEA,SAAS,CAAC,QAAQ,GAAG,MAAM,EAAE,QAAQ,CAAC,MAAM,IAAI,EAAE,CAAC,GAAG,IAAI,CAAC;AAAA,MAC/D,CAAC;AAAA,IACL;AACA,UAAM,QAAQ,MAAM;AAEpB,QAAI,eAAe,SAAU,MAAM,QAAQ,aAAa,OAAO;AAC/D,mBAAe,MAAM,QAAQ,yBAAyB,YAAY;AAElE,QAAI;AAEA,YAAM,UAAU;AAAA,QACZ;AAAA,QACA;AAAA,QACA;AAAA,MACJ;AACA,YAAM,SAAS,MAAM,aAAa;AAAA,QAC9B;AAAA,QACA;AAAA,QACA;AAAA,QACA,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA,QAKV,YAAY,WAAW;AAAA,MAC3B,CAAC;AAGD,YAAM,WAAW,uBAAuB,QAAQ,YAAY;AAC5D,YAAM,eAAe,MAAM,iBAAiB,SAAS,QAAQ;AAE7D,2CAAW;AAAA,QACP,MAAM;AAAA,QACN,SAAS,CAAC;AAAA,MACd;AACA,aAAO;AAAA,IACX,SAAS,OAAO;AACZ,YAAM,eACF,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAGzD,YAAM,gBAAgB;AAAA,QAClB;AAAA,QACA;AAAA,MACJ;AACA,YAAM,oBAAoB,MAAM;AAAA,QAC5B;AAAA,QACA;AAAA,MACJ;AAEA,2CAAW;AAAA,QACP,MAAM;AAAA,QACN,SAAS,EAAE,OAAO,aAAa;AAAA,MACnC;AACA,aAAO;AAAA,IACX;AAAA,EACJ;AACJ;AAEA,SAAS,qBACL,YACA,mBACA,OACM;AACN,QAAM,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAaf,UAAU;AAAA,EACpB,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAMf,SAAO,eAAe,EAAE,OAAO,UAAU,eAAe,CAAC;AAC7D;AAEA,SAAS,uBAAuB,QAAiB,OAAsB;AACnE,QAAM,mBAAmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAqB3B,KAAK,UAAU,MAAM,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOpB,SAAO,eAAe,EAAE,OAAO,UAAU,iBAAiB,CAAC;AAC/D;AAEA,SAAS,4BACL,cACA,OACM;AACN,QAAM,wBAAwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoBhC,YAAY;AAAA;AAAA;AAAA;AAAA;AAKV,SAAO,eAAe,EAAE,OAAO,UAAU,sBAAsB,CAAC;AACpE;AAEA,eAAe,iBACX,SACA,SACe;AACf,SAAO,aAAa;AAAA,IAChB;AAAA,IACA;AAAA,IACA,YAAY,WAAW;AAAA,EAC3B,CAAC;AACL;;;AEtNA,IAAM,aAAa;AAAA,EACf,MAAM;AAAA,EACN,aAAa;AAAA,EACb,WAAW,CAAC,kBAAkB,CAAC;AAAA,EAC/B,YAAY,CAAC;AAAA,EACb,UAAU,CAAC;AAAA,EACX,SAAS,kBAAkB;AAC/B;AACA,IAAO,gBAAQ;","names":[]}